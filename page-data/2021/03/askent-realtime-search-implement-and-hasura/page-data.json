{"componentChunkName":"component---src-templates-post-template-js","path":"/2021/03/askent-realtime-search-implement-and-hasura/","result":{"data":{"markdownRemark":{"id":"da80bfaf-f543-5db7-a178-3f59b678d535","html":"<!-- endExcerpt -->\n<h2 id=\"问题\" style=\"position:relative;\"><a href=\"#%E9%97%AE%E9%A2%98\" aria-label=\"问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>问题</h2>\n<p>在项目 <a href=\"/2020/03/real-time-multi-device-collaboration-devtools\">Askent</a> 开发中，需要同步管理后台、客户端、演示大屏，三端上的消息显示，继之前<a href=\"/2020/03/real-time-multi-device-collaboration-devtools\">使用 Apollo Subscription 基于 Pub/Sub 开发遇到问题</a>，然后参照 <a href=\"https://deepstream.io/blog/20191104-realtime-search/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DeepStream 的 Realtime Search 思路</a>实现一版后，仍有一个严重的性能问题无法解决——每个客户端会话权限、查询变量各不同，因此一个提问的 Pub 事件需要为每个客户端执行一次（实际是两次，见下文流程图）查询，再计算 diff 后向对应客户端推送增量数据。虽未进行压力测试，但可以预见这是个严重耗费性能的不好的设计。</p>\n<h2 id=\"目前实现\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E5%89%8D%E5%AE%9E%E7%8E%B0\" aria-label=\"目前实现 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目前实现</h2>\n<p>该实时搜索实现的流程如下图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 760px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3242a49d271769e1ce9dc87ac5c1a1ba/19c75/realtime-search-workflow.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.315789473684205%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAEDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHWVFSgyX//xAAaEAEAAgMBAAAAAAAAAAAAAAABAAIREjEy/9oACAEBAAEFAmzndlPKGdSV5//EABYRAAMAAAAAAAAAAAAAAAAAAAEQEv/aAAgBAwEBPwGiv//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAABEWEhQXH/2gAIAQEAAT8hSeOFqGlDSFAkYn//2gAMAwEAAgADAAAAEAAv/8QAGBEAAgMAAAAAAAAAAAAAAAAAABEBIWH/2gAIAQMBAT8Qwgbs/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAEhMf/aAAgBAgEBPxCk6//EABoQAQEAAwEBAAAAAAAAAAAAAAERACFBUTH/2gAIAQEAAT8QaopdDlwqyC+Y1XNYpPW/rlVXr1wiBDP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3242a49d271769e1ce9dc87ac5c1a1ba/5ed05/realtime-search-workflow.webp 190w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/9d76b/realtime-search-workflow.webp 380w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/33466/realtime-search-workflow.webp 760w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/ca244/realtime-search-workflow.webp 1140w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/a0b4f/realtime-search-workflow.webp 1366w\"\n              sizes=\"(max-width: 760px) 100vw, 760px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3242a49d271769e1ce9dc87ac5c1a1ba/89129/realtime-search-workflow.jpg 190w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/0036d/realtime-search-workflow.jpg 380w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/e484a/realtime-search-workflow.jpg 760w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/32d87/realtime-search-workflow.jpg 1140w,\n/static/3242a49d271769e1ce9dc87ac5c1a1ba/19c75/realtime-search-workflow.jpg 1366w\"\n            sizes=\"(max-width: 760px) 100vw, 760px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3242a49d271769e1ce9dc87ac5c1a1ba/e484a/realtime-search-workflow.jpg\"\n            alt=\"realtime-search-workflow\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>它总体分为两步：</p>\n<ol>\n<li>首先请求提问列表，服务端根据请求参数生成一个 hash，并与提问列表结果一同返回</li>\n<li>客户端用 hash 订阅提问列表</li>\n</ol>\n<h2 id=\"hasura\" style=\"position:relative;\"><a href=\"#hasura\" aria-label=\"hasura permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hasura</h2>\n<p>偶然看到文章 <a href=\"https://blog.graphqleditor.com/graphql-tools-partone/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GraphQL tools &#x26; libraries</a> 中介绍 Hasura - instant realtime GraphQL APIs on any Postgres database。</p>\n<p>看了文档 <a href=\"https://github.com/hasura/graphql-engine/blob/master/architecture/live-queries.md#scaling-to-1-million-active-graphql-subscriptions-live-queries\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Scaling to 1 million active GraphQL subscriptions (live queries)</a>(<a href=\"/2021/03/Scaling-to-1-million-active-GraphQL-subscriptions\">中文</a>)，发现它正是我需要的。</p>\n<p>目前替换提问列表的实时查询，包含用户权限的请求待验证。</p>\n<p>其他可用的实时查询、实时数据库工具：</p>\n<ul>\n<li><a href=\"https://github.com/n1ru4l/graphql-live-query\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GraphQL Live Query</a></li>\n<li><a href=\"https://www.timescale.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">TimescaleDB</a></li>\n</ul>","excerpt":"","fields":{"slug":"/2021/03/askent-realtime-search-implement-and-hasura","categorySlugs":["/category/前端/"],"tagSlugs":["/tag/graph-ql/","/tag/postgres/","/tag/hasura/","/tag/askent/","/tag/web-sockets/","/tag/realtime/","/tag/deep-stream/"]},"frontmatter":{"title":"Askent 实时消息搜索的问题及 Hasura 替代","date":"2021-03-13T10:46:37.121Z","categories":["前端"],"description":"当前参照 DeepStream 的 Realtime Search 思路实现的提问列表实时查询，存在严重耗费性能的问题，偶然发现 Hasura 正是我需要的工具。","tags":["GraphQL","Postgres","Hasura","Askent","WebSockets","realtime","DeepStream"],"slug":"/2021/03/askent-realtime-search-implement-and-hasura","featured_media":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAECBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB6yibNgiH/8QAGxAAAgIDAQAAAAAAAAAAAAAAAQIAMgMREjH/2gAIAQEAAQUCLHfZiVb2Y6//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEv/aAAgBAwEBPwGz/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABsQAAICAwEAAAAAAAAAAAAAAAABEXEQMUFh/9oACAEBAAE/IUnij1Q0obbO4P/aAAwDAQACAAMAAAAQMC//xAAYEQADAQEAAAAAAAAAAAAAAAAAAREhUf/aAAgBAwEBPxCuITun/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAERMf/aAAgBAgEBPxCidf/EABwQAAICAgMAAAAAAAAAAAAAAAERACExQVFxsf/aAAgBAQABPxA1Iw6DTgaUgniGa1UMhBVvZmcPZn//2Q=="},"images":{"fallback":{"src":"/static/3242a49d271769e1ce9dc87ac5c1a1ba/e737e/realtime-search-workflow.jpg","srcSet":"/static/3242a49d271769e1ce9dc87ac5c1a1ba/e737e/realtime-search-workflow.jpg 800w","sizes":"800px"},"sources":[{"srcSet":"/static/3242a49d271769e1ce9dc87ac5c1a1ba/e7773/realtime-search-workflow.webp 800w","type":"image/webp","sizes":"800px"}]},"width":800,"height":400}}}}},"prevPost":{"fields":{"slug":"/2021/03/Scaling-to-1-million-active-GraphQL-subscriptions"},"frontmatter":{"title":"借助 GraphQL 承载 100万并发活动订阅（实时查询）"}},"nextPost":{"fields":{"slug":"/2021/07/where-the-askent-comes-from"},"frontmatter":{"title":"Where the Askent comes from"}}},"pageContext":{"slug":"/2021/03/askent-realtime-search-implement-and-hasura","prevPostSlug":"/2021/03/Scaling-to-1-million-active-GraphQL-subscriptions","nextPostSlug":"/2021/07/where-the-askent-comes-from"}},"staticQueryHashes":["2727970573","3709504828","4110059069"],"slicesMap":{}}