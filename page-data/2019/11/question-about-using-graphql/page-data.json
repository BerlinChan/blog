{"componentChunkName":"component---src-templates-post-template-js","path":"/2019/11/question-about-using-graphql/","result":{"data":{"markdownRemark":{"id":"06808120-840b-5e3b-86a0-ae275e2ebd22","html":"<!-- endExcerpt -->\n<h2 id=\"先扯点别的\" style=\"position:relative;\"><a href=\"#%E5%85%88%E6%89%AF%E7%82%B9%E5%88%AB%E7%9A%84\" aria-label=\"先扯点别的 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>先扯点别的</h2>\n<p>上一篇准备翻译 <a href=\"https://medium.com/@martin_hotell/10-typescript-pro-tips-patterns-with-or-without-react-5799488d6680\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">10++ TypeScript Pro tips/patterns with (or without) React</a> 的，但翻译到一半后决定弃坑，强烈的挫败感，原因如下：</p>\n<p>原文最初写于 2018-10-29，自那以后 Typescript 和 React 都有很多更新(JS 的世界日新月异)，文中有些内容已不再适用。而且我觉得本文中有些建议，包括 Typescript 本身，过于追求了严格和限制，反而丧失 Javascript 的灵活优势(双刃剑，莫抬杠)。没有深入使用过 TS，所以还抱着怀疑的态度在学习中。</p>\n<p>技术文章有很多术语，翻译后反而不容易理解，原有单词放在英语语境中反而容易理解，有时候一整句保留所有术语后，翻译出来的中文就是几个”的”、“在”、“上”、“使用”，都怀疑还有没有必要翻译。</p>\n<p>下面正文开始。</p>\n<hr>\n<h2 id=\"学习-graphql\" style=\"position:relative;\"><a href=\"#%E5%AD%A6%E4%B9%A0-graphql\" aria-label=\"学习 graphql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>学习 GraphQL</h2>\n<p>老有人拿 RESTful 和 GraphQL 比较，一直很好奇，最近我就看了看。跟官方教程走了一遍后，我更喜欢 GraphQL 的另一种实现 Apollo，相比 GraphQL 更容易理解，写起来更简洁。而且与之配合的客户端 Apollo Client 要比 Relay 也更简单(虽然客户端是非必选的)，于是就选择 Apollo 全家桶了。</p>\n<p>在用 GraphQL 读写数据库，和用 Apollo Server 包装了两个现有 REST API 初步试用后，觉得这确实是个很新鲜实用的 API 方案。对于这种 <a href=\"https://www.apollographql.com/docs/tutorial/schema/#write-your-graphs-schema\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Schema First Development</a> 的开发实践方法也很赞同。但留下了一些疑问(逐渐更新，找到解决方法也会更新，求教各位)，于是记载一下。</p>\n<h2 id=\"1-如何模块化的管理本地状态\" style=\"position:relative;\"><a href=\"#1-%E5%A6%82%E4%BD%95%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9A%84%E7%AE%A1%E7%90%86%E6%9C%AC%E5%9C%B0%E7%8A%B6%E6%80%81\" aria-label=\"1 如何模块化的管理本地状态 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 如何模块化的管理本地状态?</h2>\n<p><a href=\"https://www.apollographql.com/docs/react/caching/cache-configuration/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Apollo cache</a> 缓存从远程拉取的数据，同时也具有了管理本地状态数据的能力。Apollo 官方也<a href=\"https://www.apollographql.com/docs/react/why-apollo/#combine-local--remote-data\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">推荐这么做</a>:</p>\n<blockquote>\n<p>Managing all your data with Apollo Client allows you to take advantage of GraphQL as a unified interface to all of your data.</p>\n</blockquote>\n<p>这样做的好处是，可以不再关心状态数据从远端还是本地来，一概都用 GraphQL 的 Query 来查询，用 Mutation 来更改。但随着应用的功能增加和业务复杂化，所有的状态在一个 Apollo cache 中，且所有 <code class=\"language-text\">typeDefs</code>、<code class=\"language-text\">resolvers</code> 都写在一起，<strong>很快会变得无法维护</strong>。</p>\n<p>在专门的状态管理方案中都有解决模块化问题的方案:</p>\n<ul>\n<li>Redux 中的 <a href=\"https://redux.js.org/recipes/structuring-reducers/using-combinereducers#using-combinereducers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">combineReducers</a></li>\n<li>Vuex 的<a href=\"https://vuex.vuejs.org/zh/guide/modules.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">将 store 分割成模块（module）</a></li>\n</ul>\n<h3 id=\"解决方案部分\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E9%83%A8%E5%88%86\" aria-label=\"解决方案部分 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案(部分)</h3>\n<p>在官方文档 <a href=\"https://www.apollographql.com/docs/react/data/local-state/#code-splitting\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Code splitting</a> 中提到了一点这个问题，用 <code class=\"language-text\">client</code> 实例的方法 <code class=\"language-text\">addResolvers</code>，添加模块中的 resolvers。但还是有问题：怎么分离 <code class=\"language-text\">typeDefs</code> 呢？</p>\n<p>现在看 Client 端 typeDefs 还是要写到一起去。虽然直接在 resolvers 中定义一个 typeDefs 中不存在的 <a href=\"https://graphql.org/learn/queries/#fields\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">field</a> 不会报错并可以用，但显然是个<strong>不优雅</strong>的做法。</p>\n<h3 id=\"结论\" style=\"position:relative;\"><a href=\"#%E7%BB%93%E8%AE%BA\" aria-label=\"结论 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结论</h3>\n<p>那目前我选择<strong>不用 Apollo Client 管理本地状态</strong>，若需要，还是交给 Redux 或者 MobX 这类专门工具，这样客户端几乎不用写 <code class=\"language-text\">typeDefs</code> 和 <code class=\"language-text\">resolvers</code> 从而避开模块化问题了。</p>\n<p>值得反思的是，在事情复杂到需要模块化之前，你可能不需要什么状态管理，如 Redux 作者之一 Dan Abramov 说：</p>\n<blockquote>\n<p><a href=\"https://redux.js.org/faq/general#when-should-i-use-redux\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">I would like to amend this: don’t use Redux until you have problems with vanilla React.</a></p>\n</blockquote>\n<h2 id=\"2-模板代码名称多\" style=\"position:relative;\"><a href=\"#2-%E6%A8%A1%E6%9D%BF%E4%BB%A3%E7%A0%81%E5%90%8D%E7%A7%B0%E5%A4%9A\" aria-label=\"2 模板代码名称多 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 模板代码名称多</h2>\n<p>比如我要取值 <code class=\"language-text\">someList</code>，用 Apollo Client 操作前先定义这个 schema:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">GET_SOME_LIST</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  query GetSomeList {\n    someList\n  }\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">GET_SOME_LIST</code>、<code class=\"language-text\">GetSomeList</code>、<code class=\"language-text\">someList</code> 这三个名称分别是:</p>\n<ul>\n<li>给 <code class=\"language-text\">useQuery</code>(或 <code class=\"language-text\">useMutation</code>)传参数的常量，可类比 <a href=\"https://redux.js.org/basics/actions#note-on-boilerplate\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Redux 中的 Action type</a></li>\n<li><a href=\"https://graphql.org/learn/queries/#operation-name\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GraphQL 操作名</a>，非必须</li>\n<li>GraphQL <a href=\"https://graphql.org/learn/queries/#fields\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">field</a> 名</li>\n</ul>\n<p>这三个名称看起来很类似，但是为了程序可读性它们都按这样的模板写好。现在名称很短还不成问题，但在上一个模块问题没解决前，可能需要用加前缀当作命名空间，避免命名冲突，比如：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">SET_DASHBOARD_LIST_EXPANDED</span> <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    mutation SetDashBoardListExpanded($ids:[ID]!){\n        setDashBoardListExpanded(ids:$ids):[ID]!\n    }\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>啊，看不清了 😵</p>\n<h3 id=\"解决方案\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88\" aria-label=\"解决方案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h3>\n<p>老老实实写。用 <a href=\"https://graphql-code-generator.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">GraphQL Code Generator</a> 辅助生成，能缓解部分手工写模板代码的工作。</p>\n<h4 id=\"2019-12-24-更新\" style=\"position:relative;\"><a href=\"#2019-12-24-%E6%9B%B4%E6%96%B0\" aria-label=\"2019 12 24 更新 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2019-12-24 更新</h4>\n<p>GraphQL Code Generator 的使用案例参考：<a href=\"https://levelup.gitconnected.com/build-a-graphql-react-app-with-typescript-9661f908b26\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Build a GraphQL + React App with TypeScript</a></p>\n<h2 id=\"3-如何身份验证2019-12-04-更新\" style=\"position:relative;\"><a href=\"#3-%E5%A6%82%E4%BD%95%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%812019-12-04-%E6%9B%B4%E6%96%B0\" aria-label=\"3 如何身份验证2019 12 04 更新 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 如何身份验证？(2019-12-04 更新)</h2>\n<p>这是我接触 GraphQL 的第一个问题。GraphQL 给我最初的感觉是将数据库读写直接暴露给应用程序端了，当然这是个<strong>错误(或浅显)的认识</strong>。身份验证怎么办？这样岂不是可以瞎搞？🤪</p>\n<h3 id=\"解决方案-1\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1\" aria-label=\"解决方案 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h3>\n<p>在 Apollo Server、Client 加上身份验证的逻辑就行，官方教程与文档已经写得很清楚了。请参考：</p>\n<ul>\n<li><a href=\"https://www.apollographql.com/docs/tutorial/resolvers/#authenticate-users\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">教程：Apollo 身份验证</a></li>\n<li><a href=\"https://www.apollographql.com/docs/apollo-server/security/authentication/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文档：Apollo 服务端身份验证</a></li>\n<li><a href=\"https://www.apollographql.com/docs/react/networking/authentication/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">文档：Apollo 客户端身份验证</a></li>\n</ul>\n<h2 id=\"4-如何更方便将数据库接入-apollo-server2019-12-05-更新\" style=\"position:relative;\"><a href=\"#4-%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B9%E4%BE%BF%E5%B0%86%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8E%A5%E5%85%A5-apollo-server2019-12-05-%E6%9B%B4%E6%96%B0\" aria-label=\"4 如何更方便将数据库接入 apollo server2019 12 05 更新 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 如何更方便将数据库接入 Apollo Server？(2019-12-05 更新)</h2>\n<p>Apollo Server 结合 npm 包 <code class=\"language-text\">pg-promise</code>、<code class=\"language-text\">monk</code> 这类工具很方便将 Postgre、MongoDB 数据库作为数据源接入，代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ApolloServer <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"apollo-server\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> gql <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"apollo-server\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> pgp <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pg-promise\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> connectionString <span class=\"token operator\">=</span> <span class=\"token string\">\"postgres://username:password@host:port/database\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> db <span class=\"token operator\">=</span> <span class=\"token function\">pgp</span><span class=\"token punctuation\">(</span>connectionString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> typeDefs <span class=\"token operator\">=</span> gql<span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n  type Query {\n    user(id: ID!): User\n  }\n\n  type User {\n    id: ID!\n    name: String\n    email: String\n  }\n</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> resolvers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">Query</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">user</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">,</span> info</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> query <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">SELECT id,name,email FROM table_user WHERE id = '</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">one</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApolloServer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  typeDefs<span class=\"token punctuation\">,</span>\n  resolvers\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">🚀 Server ready at </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>但显然有个不够自动化的问题——<strong>需要根据数据库表结构定义手工写 schema</strong>，如上例中的 <code class=\"language-text\">User</code>，对于不同的查询参数也需要手动写 resolver。我想，数据库中定义好的表结构应该能根据一定的规则转换为 schema，于是朋友推荐看了 <a href=\"https://www.prisma.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Prisma</a>。</p>\n<h3 id=\"解决方案-2\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2\" aria-label=\"解决方案 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解决方案</h3>\n<p><a href=\"https://www.prisma.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Prisma</a> 可以解决上面的问题，自动根据现有数据表派生 datamodel（即 GraphQL 术语中的 schema，或者反过来，根据 datamodel 建立数据库表），并自动生成客户端。</p>\n<blockquote>\n<p>Prisma 替代传统 ORMs 并简化数据库工作流程</p>\n</blockquote>\n<p>ORM(Object Relational Mapping)意为对象关系映射，将面向对象语言程序中的对象自动持久化到关系数据库中。关于它的解释请见<a href=\"http://www.ruanyifeng.com/blog/2019/02/orm-tutorial.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ORM 实例教程</a>。</p>\n<p>之前看 Java 同事用 <a href=\"https://hibernate.org/orm/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hibernate</a> 操作数据库好爽的，原来 JS 里面也可以了。</p>\n<p>这东西给我（作为前端开发）感觉是，<strong>轻松拉近应用程序端与数据库的距离</strong>，在开发中有了更多想象与尝试空间。</p>\n<h3 id=\"在-api-中添加业务逻辑而不是直接暴露-crud2020-01-17-更新\" style=\"position:relative;\"><a href=\"#%E5%9C%A8-api-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E8%80%8C%E4%B8%8D%E6%98%AF%E7%9B%B4%E6%8E%A5%E6%9A%B4%E9%9C%B2-crud2020-01-17-%E6%9B%B4%E6%96%B0\" aria-label=\"在 api 中添加业务逻辑而不是直接暴露 crud2020 01 17 更新 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>在 API 中添加业务逻辑，而不是直接暴露 CRUD(2020-01-17 更新)</h3>\n<p>可以直接借助 Prisma Photon 暴露操作数据库的 <a href=\"https://github.com/prisma/prisma2/blob/master/docs/photon/api.md#crud\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CRUD</a> 方法，但更多的情况是 API 中有特定业务逻辑，而不是直接将数据写到数据库，这才是 API 这一环节的真正作用所在。</p>\n<p>不同的环节数据模型也有所差异，这正是 <strong>PO、DTO、VO</strong> 所定义的。</p>\n<h2 id=\"5-field-为-list-时的两个感叹号2019-12-27-更新\" style=\"position:relative;\"><a href=\"#5-field-%E4%B8%BA-list-%E6%97%B6%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%84%9F%E5%8F%B9%E5%8F%B72019-12-27-%E6%9B%B4%E6%96%B0\" aria-label=\"5 field 为 list 时的两个感叹号2019 12 27 更新 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Field 为 List 时的两个感叹号？(2019-12-27 更新)</h2>\n<p>例如定义 Field <code class=\"language-text\">tags</code> 为如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"graphql\"><pre class=\"language-graphql\"><code class=\"language-graphql\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">TwoExclamation</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attr-name\">tags</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token scalar\">String</span><span class=\"token operator\">!</span><span class=\"token punctuation\">]</span><span class=\"token operator\">!</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">[String!]!</code> 有两个感叹号。</p>\n<ul>\n<li><strong>第一个</strong> <code class=\"language-text\">!</code>(String 后面) 表示 <code class=\"language-text\">tags</code> 中没有元素可为 <code class=\"language-text\">null</code>，比如这个是无效的：[“Software”, null, “Prisma”]。可以期望请求结果中 <code class=\"language-text\">tags</code> 的每个元素都为 <code class=\"language-text\">String</code>。</li>\n<li><strong>第二个</strong> <code class=\"language-text\">!</code>(] 后面) 表示该 List 不可为 <code class=\"language-text\">null</code>，尽管可为空列表。所以对于 <code class=\"language-text\">tags</code>，<code class=\"language-text\">null</code> 是无效值而 <code class=\"language-text\">[]</code> 有效。可以期望请求结果中 <code class=\"language-text\">tags</code> 一定是个数组。</li>\n</ul>\n<p>这样明确定义，让我们在处理数据时省掉类型判断与容错，而不必担心<code class=\"language-text\">类型错误</code>的出现。</p>\n<h2 id=\"6-graphql-的性能如何2020-01-17-更新\" style=\"position:relative;\"><a href=\"#6-graphql-%E7%9A%84%E6%80%A7%E8%83%BD%E5%A6%82%E4%BD%952020-01-17-%E6%9B%B4%E6%96%B0\" aria-label=\"6 graphql 的性能如何2020 01 17 更新 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. GraphQL 的性能如何？(2020-01-17 更新)</h2>\n<p>参考项目 <a href=\"https://github.com/benawad/node-graphql-benchmarks\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">node-graphql-benchmarks</a></p>\n<h2 id=\"7-a-graphqlapolloprismareactmaterialui-tech-stack-project\" style=\"position:relative;\"><a href=\"#7-a-graphqlapolloprismareactmaterialui-tech-stack-project\" aria-label=\"7 a graphqlapolloprismareactmaterialui tech stack project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>7. A GraphQL+Apollo+Prisma+React+MaterialUI tech-stack project</h2>\n<p>我正在用这一系列技术栈开发 Askent 项目——一个现场交互演示工具，它的介绍请见：<a href=\"/2019/12/create-presentation-tool-from-scratch/\">从零开始，创建一个多端互动演示工具</a>。</p>\n<p>Github Repository: <a href=\"https://github.com/BerlinChan/askent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/BerlinChan/askent</a></p>","excerpt":"","fields":{"slug":"/2019/11/question-about-using-graphql","categorySlugs":["/category/前端/"],"tagSlugs":["/tag/graph-ql/","/tag/api/"]},"frontmatter":{"title":"学习 GraphQL 的疑问和解決方案","date":"2019-11-29T10:46:37.121Z","categories":["前端"],"description":"在试用 GraphQL 读写数据库和包装现有 REST 后，觉得确实是新鲜实用的 API 方案。对于这种 Schema First Development 的开发实践方法也很赞同。但留下了一些疑问(和解决方法)，于是记载一下。","tags":["GraphQL","API"],"slug":"/2019/11/question-about-using-graphql","featured_media":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHHmqgT/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFhAAAwAAAAAAAAAAAAAAAAAAAAEg/9oACAEBAAE/IRz/AP/aAAwDAQACAAMAAAAQO+//xAAXEQEAAwAAAAAAAAAAAAAAAAABEBEh/9oACAEDAQE/EByo/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAFxABAQEBAAAAAAAAAAAAAAAAARARAP/aAAgBAQABPxA4hmQv/9k="},"images":{"fallback":{"src":"/static/87571c3887c15db44e2431b33008c331/e737e/featured_media.jpg","srcSet":"/static/87571c3887c15db44e2431b33008c331/e737e/featured_media.jpg 800w","sizes":"800px"},"sources":[{"srcSet":"/static/87571c3887c15db44e2431b33008c331/e7773/featured_media.webp 800w","type":"image/webp","sizes":"800px"}]},"width":800,"height":400}}}}},"prevPost":{"fields":{"slug":"/2019/11/qianjiang-marathon"},"frontmatter":{"title":"潜江返湾湖湿地马拉松健康跑"}},"nextPost":{"fields":{"slug":"/2019/12/common-problems-in-using-gnuPg"},"frontmatter":{"title":"使用 GnuPG 的常见问题"}}},"pageContext":{"slug":"/2019/11/question-about-using-graphql","prevPostSlug":"/2019/11/qianjiang-marathon","nextPostSlug":"/2019/12/common-problems-in-using-gnuPg"}},"staticQueryHashes":["2727970573","3709504828","4110059069"],"slicesMap":{}}